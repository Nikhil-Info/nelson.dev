---
title: Better Auth를 사용한 E2E 테스트
date: '2025-09-17T07:01:11.746Z'
modifiedTime: '2025-09-17T07:01:11.746Z'
summary: Better Auth로 엔드투엔드 테스트를 설정하는 방법을 알아보세요.
---

## TL;DR

유효한 세션 토큰을 생성하고 쿠키로 저장해야 합니다. 이를 통해 E2E 테스트에서 수동 로그인 없이 인증된 경로에 접근할 수 있습니다. 이 방법은 자격 증명 기반 인증과 OAuth 모두에서 작동합니다.

> GitHub 저장소: [nelsonlaidev/e2e-testing-with-better-auth](https://github.com/nelsonlaidev/e2e-testing-with-better-auth)

## 서문

이 가이드에서는 [Playwright](https://playwright.dev/)를 E2E 테스트 프레임워크로 사용하지만, 개념은 [Cypress](https://www.cypress.io/)와 같은 다른 프레임워크에도 적용할 수 있습니다.

단순화를 위해 자격 증명 기반 인증 예제를 사용하겠습니다. 그러나 동일한 원칙이 OAuth 공급자에도 적용됩니다.

또한 데모 목적으로 SQLite 데이터베이스를 사용합니다. 데이터베이스 상호작용**(예: 테이블 이름, 열 유형)**을 여러분의 설정에 맞게 구성하세요.

## 세션 토큰 생성

인증된 세션을 시뮬레이션하려면 `BETTER_AUTH_SECRET`을 사용하여 서명된 세션 토큰을 생성해야 합니다. 이 토큰은 세션 쿠키에서 사용됩니다.

```ts
import crypto from 'node:crypto'

export const TEST_USER = {
  name: '테스트 사용자',
  email: 'test@example.com',
  sessionToken: '00000000000000000000000000000000',
  accountId: '000'
}

const signature = crypto
  .createHmac('sha256', process.env.BETTER_AUTH_SECRET!)
  .update(TEST_USER.sessionToken)
  .digest('base64')
const signedValue = `${TEST_USER.sessionToken}.${signature}`
```

## 테스트 데이터 삽입

테스트 중 여러 사용자를 생성하는 것을 피하기 위해 테스트 사용자를 정적으로 유지하려고 합니다. 아직 존재하지 않는 경우 테스트 사용자, 계정 및 세션을 데이터베이스에 삽입하세요. 간단함을 위해 모든 기본 키에 대해 `0`을 고유 식별자로 사용합니다.

```ts
import { db } from '@/lib/db'

const TEST_UNIQUE_ID = '0'

const now = new Date().getTime()
const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).getTime() // 7일

const transaction = db.transaction(() => {
  db.prepare(
    `
      INSERT OR IGNORE INTO user (
        id, name, email, emailVerified, createdAt, updatedAt
      ) VALUES (?, ?, ?, ?, ?, ?)
    `
  ).run(TEST_UNIQUE_ID, TEST_USER.name, TEST_USER.email, 0, now, now)

  db.prepare(
    `
      INSERT OR IGNORE INTO account (
        id, accountId, providerId, userId, password, createdAt, updatedAt
      ) VALUES (?, ?, ?, ?, ?, ?, ?)
    `
  ).run(TEST_UNIQUE_ID, TEST_USER.accountId, 'credential', TEST_UNIQUE_ID, 'password_hash', now, now)

  db.prepare(
    `
      INSERT INTO session (
        id, token, userId, expiresAt, createdAt, updatedAt
      ) VALUES (?, ?, ?, ?, ?, ?)
      ON CONFLICT(token) DO UPDATE SET
      expiresAt = excluded.expiresAt,
      updatedAt = excluded.updatedAt
    `
  ).run(TEST_UNIQUE_ID, TEST_USER.sessionToken, TEST_UNIQUE_ID, expiresAt, now, now)
})

transaction()
```

## 세션 저장

서명된 토큰을 테스트 프레임워크에서 사용할 수 있도록 JSON 파일에 쿠키로 저장하세요. `encodeURIComponent{:.entity.name.function}`를 사용하여 쿠키 값을 인코딩하는 것을 잊지 마세요.

```ts
import fs from 'node:fs/promises'

const cookieObject = {
  name: 'better-auth.session_token',
  value: encodeURIComponent(signedValue), // [!code highlight]
  domain: 'localhost',
  path: '/',
  httpOnly: true,
  secure: false,
  sameSite: 'Lax',
  expires: Math.round(expiresAt / 1000)
}

await fs.writeFile('.auth/auth.json', JSON.stringify({ cookies: [cookieObject], origins: [] }, null, 2))
```

## 테스트에서 세션 사용

저장된 세션을 E2E 테스트에서 로드하여 로그인 없이 보호된 경로에 접근하세요. 다음 예제는 Playwright를 사용하지만, 쿠키 주입을 지원하는 모든 테스트 라이브러리(예: Cypress)에 적용할 수 있습니다.

```ts title='playwright.config.ts'
export default defineConfig({
  // ...
  projects: [
    { name: 'setup', testMatch: /global\.setup\.ts/, teardown: 'teardown' }, // [!code highlight]

    { name: 'teardown', testMatch: /global\.teardown\.ts/ }, // [!code highlight]

    {
      name: 'chromium',
      use: {
        ...devices['Desktop Chrome'],
        storageState: '.auth/auth.json' // [!code highlight]
      },
      dependencies: ['setup'] // [!code highlight]
    }
  ]
})
```

## 유용한 링크

- [Playwright 설정 및 해제](https://playwright.dev/docs/test-global-setup-teardown)
- [Playwright 저장소 상태](https://playwright.dev/docs/auth#reuse-authentication-in-other-scenarios)
- [Cypress 훅](https://docs.cypress.io/app/core-concepts/writing-and-organizing-tests#Hooks)
- [Cypress에서 쿠키 설정](https://docs.cypress.io/api/commands/setcookie)