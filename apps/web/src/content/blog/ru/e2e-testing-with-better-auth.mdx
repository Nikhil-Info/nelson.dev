---
title: E2E тестирование с Better Auth
date: '2025-09-17T07:01:11.746Z'
modifiedTime: '2025-09-17T07:01:11.746Z'
summary: Узнайте, как настроить сквозное тестирование с Better Auth.
---

## TL;DR

Вам нужно будет сгенерировать действительный токен сессии и сохранить его в виде куки. Это позволяет вашим E2E тестам получать доступ к аутентифицированным маршрутам без ручного входа в систему. Этот метод работает как для аутентификации на основе учетных данных, так и для OAuth.

> Репозиторий GitHub: [nelsonlaidev/e2e-testing-with-better-auth](https://github.com/nelsonlaidev/e2e-testing-with-better-auth)

## Предисловие

В этом руководстве мы будем использовать [Playwright](https://playwright.dev/) в качестве нашего фреймворка для E2E тестирования, но концепции можно применить к другим фреймворкам, таким как [Cypress](https://www.cypress.io/).

Для простоты мы будем использовать пример аутентификации на основе учетных данных. Однако те же принципы применяются к провайдерам OAuth.

Также мы используем базу данных SQLite для демонстрационных целей. Настройте взаимодействия с базой данных **(например, имена таблиц, типы столбцов)** в соответствии с вашей настройкой.

## Генерация токена сессии

Чтобы имитировать аутентифицированную сессию, нам нужно сгенерировать подписанный токен сессии с помощью `BETTER_AUTH_SECRET`. Этот токен будет использоваться в куки сессии.

```ts
import crypto from 'node:crypto'

export const TEST_USER = {
  name: 'Тестовый пользователь',
  email: 'test@example.com',
  sessionToken: '00000000000000000000000000000000',
  accountId: '000'
}

const signature = crypto
  .createHmac('sha256', process.env.BETTER_AUTH_SECRET!)
  .update(TEST_USER.sessionToken)
  .digest('base64')
const signedValue = `${TEST_USER.sessionToken}.${signature}`
```

## Вставка тестовых данных

Мы хотим сохранить нашего тестового пользователя статичным, чтобы избежать создания нескольких пользователей во время тестов. Вставьте тестового пользователя, учетную запись и сессию в базу данных, если они еще не существуют. Мы используем `0` в качестве уникального идентификатора для всех первичных ключей для простоты.

```ts
import { db } from '@/lib/db'

const TEST_UNIQUE_ID = '0'

const now = new Date().getTime()
const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).getTime() // 7 дней

const transaction = db.transaction(() => {
  db.prepare(
    `
      INSERT OR IGNORE INTO user (
        id, name, email, emailVerified, createdAt, updatedAt
      ) VALUES (?, ?, ?, ?, ?, ?)
    `
  ).run(TEST_UNIQUE_ID, TEST_USER.name, TEST_USER.email, 0, now, now)

  db.prepare(
    `
      INSERT OR IGNORE INTO account (
        id, accountId, providerId, userId, password, createdAt, updatedAt
      ) VALUES (?, ?, ?, ?, ?, ?, ?)
    `
  ).run(TEST_UNIQUE_ID, TEST_USER.accountId, 'credential', TEST_UNIQUE_ID, 'password_hash', now, now)

  db.prepare(
    `
      INSERT INTO session (
        id, token, userId, expiresAt, createdAt, updatedAt
      ) VALUES (?, ?, ?, ?, ?, ?)
      ON CONFLICT(token) DO UPDATE SET
      expiresAt = excluded.expiresAt,
      updatedAt = excluded.updatedAt
    `
  ).run(TEST_UNIQUE_ID, TEST_USER.sessionToken, TEST_UNIQUE_ID, expiresAt, now, now)
})

transaction()
```

## Сохранение сессии

Сохраните подписанный токен в виде куки в JSON файле для использования в фреймворках тестирования. Не забудьте закодировать значение куки с помощью `encodeURIComponent{:.entity.name.function}`.

```ts
import fs from 'node:fs/promises'

const cookieObject = {
  name: 'better-auth.session_token',
  value: encodeURIComponent(signedValue), // [!code highlight]
  domain: 'localhost',
  path: '/',
  httpOnly: true,
  secure: false,
  sameSite: 'Lax',
  expires: Math.round(expiresAt / 1000)
}

await fs.writeFile('.auth/auth.json', JSON.stringify({ cookies: [cookieObject], origins: [] }, null, 2))
```

## Использование сессии в тестах

Загрузите сохраненную сессию в ваших E2E тестах для доступа к защищенным маршрутам без входа в систему. В следующем примере используется Playwright, но это можно адаптировать к любой библиотеке тестирования (например, Cypress), которая поддерживает инъекцию куки.

```ts title='playwright.config.ts'
export default defineConfig({
  // ...
  projects: [
    { name: 'setup', testMatch: /global\.setup\.ts/, teardown: 'teardown' }, // [!code highlight]

    { name: 'teardown', testMatch: /global\.teardown\.ts/ }, // [!code highlight]

    {
      name: 'chromium',
      use: {
        ...devices['Desktop Chrome'],
        storageState: '.auth/auth.json' // [!code highlight]
      },
      dependencies: ['setup'] // [!code highlight]
    }
  ]
})
```

## Полезные ссылки

- [Настройка и завершение Playwright](https://playwright.dev/docs/test-global-setup-teardown)
- [Состояние хранилища Playwright](https://playwright.dev/docs/auth#reuse-authentication-in-other-scenarios)
- [Хуки Cypress](https://docs.cypress.io/app/core-concepts/writing-and-organizing-tests#Hooks)
- [Установить куки в Cypress](https://docs.cypress.io/api/commands/setcookie)