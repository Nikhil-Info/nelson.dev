---
title: E2E-Tests mit Better Auth
date: '2025-09-17T07:01:11.746Z'
modifiedTime: '2025-09-17T07:01:11.746Z'
summary: Erfahren Sie, wie Sie End-to-End-Tests mit Better Auth einrichten.
---

## TL;DR

Sie müssen ein gültiges Sitzungstoken generieren und als Cookies speichern. Dies ermöglicht Ihren E2E-Tests den Zugriff auf authentifizierte Routen ohne manuelle Anmeldung. Diese Methode funktioniert sowohl für anmeldebasierte als auch für OAuth-Authentifizierung.

> GitHub Repo: [nelsonlaidev/e2e-testing-with-better-auth](https://github.com/nelsonlaidev/e2e-testing-with-better-auth)

## Vorwort

In dieser Anleitung verwenden wir [Playwright](https://playwright.dev/) als unser E2E-Test-Framework, aber die Konzepte können auf andere Frameworks wie [Cypress](https://www.cypress.io/) angewendet werden.

Der Einfachheit halber verwenden wir ein anmeldebasiertes Authentifizierungsbeispiel. Die gleichen Prinzipien gelten jedoch für OAuth-Provider.

Außerdem verwenden wir eine SQLite-Datenbank für Demonstrationszwecke. Passen Sie die Datenbankinteraktionen **(z.B. Tabellennamen, Spaltentypen)** entsprechend Ihrem Setup an.

## Generierung eines Sitzungstokens

Um eine authentifizierte Sitzung zu simulieren, müssen wir ein signiertes Sitzungstoken mit `BETTER_AUTH_SECRET` generieren. Dieses Token wird in Sitzungs-Cookies verwendet.

```ts
import crypto from 'node:crypto'

export const TEST_USER = {
  name: 'Test Benutzer',
  email: 'test@example.com',
  sessionToken: '00000000000000000000000000000000',
  accountId: '000'
}

const signature = crypto
  .createHmac('sha256', process.env.BETTER_AUTH_SECRET!)
  .update(TEST_USER.sessionToken)
  .digest('base64')
const signedValue = `${TEST_USER.sessionToken}.${signature}`
```

## Einfügen von Testdaten

Wir möchten unseren Testbenutzer statisch halten, um die Erstellung mehrerer Benutzer während der Tests zu vermeiden. Fügen Sie einen Testbenutzer, ein Konto und eine Sitzung in die Datenbank ein, falls sie noch nicht existieren. Wir verwenden `0` als eindeutige ID für alle Primärschlüssel der Einfachheit halber.

```ts
import { db } from '@/lib/db'

const TEST_UNIQUE_ID = '0'

const now = new Date().getTime()
const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).getTime() // 7 Tage

const transaction = db.transaction(() => {
  db.prepare(
    `
      INSERT OR IGNORE INTO user (
        id, name, email, emailVerified, createdAt, updatedAt
      ) VALUES (?, ?, ?, ?, ?, ?)
    `
  ).run(TEST_UNIQUE_ID, TEST_USER.name, TEST_USER.email, 0, now, now)

  db.prepare(
    `
      INSERT OR IGNORE INTO account (
        id, accountId, providerId, userId, password, createdAt, updatedAt
      ) VALUES (?, ?, ?, ?, ?, ?, ?)
    `
  ).run(TEST_UNIQUE_ID, TEST_USER.accountId, 'credential', TEST_UNIQUE_ID, 'password_hash', now, now)

  db.prepare(
    `
      INSERT INTO session (
        id, token, userId, expiresAt, createdAt, updatedAt
      ) VALUES (?, ?, ?, ?, ?, ?)
      ON CONFLICT(token) DO UPDATE SET
      expiresAt = excluded.expiresAt,
      updatedAt = excluded.updatedAt
    `
  ).run(TEST_UNIQUE_ID, TEST_USER.sessionToken, TEST_UNIQUE_ID, expiresAt, now, now)
})

transaction()
```

## Speichern der Sitzung

Speichern Sie das signierte Token als Cookie in einer JSON-Datei zur Verwendung in Test-Frameworks. Vergessen Sie nicht, den Cookie-Wert mit `encodeURIComponent{:.entity.name.function}` zu kodieren.

```ts
import fs from 'node:fs/promises'

const cookieObject = {
  name: 'better-auth.session_token',
  value: encodeURIComponent(signedValue), // [!code highlight]
  domain: 'localhost',
  path: '/',
  httpOnly: true,
  secure: false,
  sameSite: 'Lax',
  expires: Math.round(expiresAt / 1000)
}

await fs.writeFile('.auth/auth.json', JSON.stringify({ cookies: [cookieObject], origins: [] }, null, 2))
```

## Verwenden der Sitzung in Tests

Laden Sie die gespeicherte Sitzung in Ihren E2E-Tests, um auf geschützte Routen zuzugreifen, ohne sich anmelden zu müssen. Das folgende Beispiel verwendet Playwright, kann aber an jede Testbibliothek (z.B. Cypress) angepasst werden, die Cookie-Injection unterstützt.

```ts title='playwright.config.ts'
export default defineConfig({
  // ...
  projects: [
    { name: 'setup', testMatch: /global\.setup\.ts/, teardown: 'teardown' }, // [!code highlight]

    { name: 'teardown', testMatch: /global\.teardown\.ts/ }, // [!code highlight]

    {
      name: 'chromium',
      use: {
        ...devices['Desktop Chrome'],
        storageState: '.auth/auth.json' // [!code highlight]
      },
      dependencies: ['setup'] // [!code highlight]
    }
  ]
})
```

## Nützliche Links

- [Playwright Setup und Teardown](https://playwright.dev/docs/test-global-setup-teardown)
- [Playwright Storage State](https://playwright.dev/docs/auth#reuse-authentication-in-other-scenarios)
- [Cypress Hooks](https://docs.cypress.io/app/core-concepts/writing-and-organizing-tests#Hooks)
- [Cypress Set Cookie](https://docs.cypress.io/api/commands/setcookie)
